---
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import Layout from "../../components/Layout.astro";
import EntryCard from "../../components/EntryCard.astro";
import TagProfileHeader from "../../components/TagProfileHeader.astro";
import TagStats from "../../components/TagStats.astro";
import { getTagMetadata, getDefaultTagMetadata } from "../../utils/tagData";

export const getStaticPaths = (async () => {
  const allEntries = await getCollection("entries");
  const tagSet = new Set<string>();

  allEntries.forEach((entry) => {
    entry.data.tags.forEach((tag) => tagSet.add(tag));
  });

  return Array.from(tagSet).map((tag) => ({
    params: { slug: tag },
    props: {
      tag,
      entries: allEntries.filter((entry) => entry.data.tags.includes(tag)),
    },
  }));
}) satisfies GetStaticPaths;

const { tag, entries } = Astro.props;
const sortedEntries = entries.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

function getExcerpt(content: string): string {
  const lines = content
    .split("\n")
    .filter((line) => line.trim() && !line.startsWith("#"));
  return lines[0]?.substring(0, 100) || "";
}

// タグメタデータの取得
const tagMetadata = (await getTagMetadata(tag)) || getDefaultTagMetadata(tag);

// 影響・失敗例の抽出（impactLevel が large のエントリを優先）
const impactExamples = sortedEntries
  .filter((entry) => entry.data.impactLevel === "large")
  .slice(0, 3);
---

<Layout title={`${tag} | DepthForge`}>
  <!-- ヘッダーセクション -->
  <TagProfileHeader
    name={tagMetadata.name}
    description={tagMetadata.description}
    icon={tagMetadata.icon}
  />

  <!-- 発生しやすい状況 -->
  {
    tagMetadata.contexts.length > 0 && (
      <section class="py-12 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            発生しやすい状況
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {tagMetadata.contexts.map((context) => (
              <div class="bg-white border border-gray-200 rounded-lg p-4 hover-lift">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">⚠️</span>
                  <p class="text-gray-700 flex-1">{context}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- 思考の癖 -->
  {
    tagMetadata.causePatterns.length > 0 && (
      <section class="py-12 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">思考の癖</h2>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
            <ul class="space-y-3">
              {tagMetadata.causePatterns.map((pattern) => (
                <li class="flex items-start gap-3">
                  <span class="text-red-500 font-bold mt-1">×</span>
                  <p class="text-gray-700 flex-1">{pattern}</p>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </section>
    )
  }

  <!-- 影響・失敗例 -->
  {
    impactExamples.length > 0 && (
      <section class="py-12 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">影響・失敗例</h2>
          <p class="text-gray-600 mb-6">
            このパターンが引き起こした代表的な失敗
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {impactExamples.map((entry) => (
              <a
                href={`/entries/${entry.slug}`}
                class="block bg-white border-2 border-red-200 rounded-lg p-6 hover-lift"
              >
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded font-medium">
                    影響度: 大
                  </span>
                  <span class="text-xs text-gray-500">{entry.data.date}</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                  {entry.data.title}
                </h3>
                <p class="text-sm text-gray-600 line-clamp-2">
                  {getExcerpt(entry.body)}
                </p>
              </a>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- 再発防止ルール -->
  {
    tagMetadata.avoidanceRules.length > 0 && (
      <section class="py-12 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">再発防止ルール</h2>
          <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
            <ol class="space-y-4">
              {tagMetadata.avoidanceRules.map((rule, index) => (
                <li class="flex items-start gap-4">
                  <span class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                    {index + 1}
                  </span>
                  <p class="text-gray-700 flex-1 pt-1">{rule}</p>
                </li>
              ))}
            </ol>
          </div>
        </div>
      </section>
    )
  }

  <!-- 統計情報 -->
  <TagStats entries={entries} tagName={tag} />

  <!-- エントリ一覧 -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-2xl font-bold text-gray-900">関連エントリ</h2>
        <a
          href="/tags"
          class="text-sm text-gray-600 hover:text-gray-900 transition-colors"
        >
          ← タグ一覧に戻る
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          sortedEntries.map((entry) => (
            <EntryCard
              title={entry.data.title}
              date={entry.data.date}
              sourceType={entry.data.sourceType}
              tags={entry.data.tags}
              excerpt={getExcerpt(entry.body)}
              slug={entry.slug}
            />
          ))
        }
      </div>
    </div>
  </section>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
